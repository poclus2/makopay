datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum UserRole {
  USER
  ADMIN
  SUPPORT
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  CANCELLED
}

enum InvestmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  SUSPENDED
}

enum PayoutFrequency {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

enum WalletTransactionType {
  INVESTMENT_PAYOUT
  MLM_COMMISSION
  WITHDRAWAL
  ADJUSTMENT
  DEPOSIT
  PURCHASE
}

enum LedgerSource {
  ORDER        // Money coming from an order payment
  INVESTMENT   // Money coming from investment yield
  MLM          // Money coming from network commissions
  ADMIN        // Manual adjustment by admin
  WITHDRAWAL   // Money leaving the system
}

// -----------------------------------------------------------------------------
// Models
// -----------------------------------------------------------------------------

model User {
  id            String    @id @default(uuid())
  email         String?
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  role          UserRole  @default(USER)
  kycStatus     KycStatus @default(PENDING) @map("kyc_status")
  sponsorId     String?   @map("sponsor_id")
  phoneNumber   String    @unique @map("phone_number")
  referralCode  String?   @unique @map("referral_code")
  
  // OTP / Verification
  phoneVerified Boolean   @default(false) @map("phone_verified")
  otpCode       String?   @map("otp_code")
  otpExpiresAt  DateTime? @map("otp_expires_at")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // KYC Data
  kycData       Json?     @map("kyc_data") // { documentType, frontUrl, backUrl, selfieUrl }
  kycSubmittedAt DateTime? @map("kyc_submitted_at")

  // Relations
  sponsor       User?     @relation("SponsorRelation", fields: [sponsorId], references: [id])
  referrals     User[]    @relation("SponsorRelation")
  orders        Order[]
  investments   Investment[]
  wallet        Wallet?
  mlmPositions  MlmTree[] @relation("UserPosition")
  mlmSponsorPos MlmTree[] @relation("SponsorPosition")
  commissionsEarned MlmCommission[] @relation("Earner")
  commissionsGenerated MlmCommission[] @relation("Buyer")
  depositRequests DepositRequest[]
  notifications Notification[]
  
  // Support Relations
  supportConversations SupportConversation[]
  assignedTickets      SupportConversation[] @relation("AssignedSupport")
  supportMessages      SupportMessage[]

  @@map("users")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  message   String
  type      String   // 'INFO', 'SUCCESS', 'WARNING', 'ERROR'
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model Product {
  id              String   @id @default(uuid())
  name            String
  description     String?
  sku             String   @unique
  price           Decimal  @db.Decimal(20, 8)
  stock           Int
  imageUrl        String?  @map("image_url")
  isCommissionable Boolean @default(true) @map("is_commissionable")
  investmentPlanId String? @map("investment_plan_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  investmentPlan  InvestmentPlan? @relation(fields: [investmentPlanId], references: [id])
  orderItems      OrderItem[]

  @@map("products")
}

model InvestmentPlan {
  id              String   @id @default(uuid())
  name            String
  durationDays    Int      @map("duration_days")
  yieldPercent    Decimal  @map("yield_percent") @db.Decimal(5, 2)
  payoutFrequency PayoutFrequency @default(MONTHLY) @map("payout_frequency")
  minAmount       Decimal  @default(0) @map("min_amount") @db.Decimal(14, 4)
  maxAmount       Decimal? @map("max_amount") @db.Decimal(14, 4)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  products        Product[]
  investments     Investment[]

  @@map("investment_plans")
}

model Order {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  totalAmount Decimal     @map("total_amount") @db.Decimal(20, 8)
  status      OrderStatus @default(PENDING)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  deletedAt   DateTime?   @map("deleted_at")

  // Relations
  user        User        @relation(fields: [userId], references: [id])
  items       OrderItem[]
  investment  Investment? // Optional: Only if order generates an investment
  commissions MlmCommission[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Int
  unitPrice Decimal @map("unit_price") @db.Decimal(20, 8)

  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Investment {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  orderId         String           @unique @map("order_id")
  planId          String           @map("plan_id")
  principalAmount Decimal          @map("principal_amount") @db.Decimal(20, 8)
  startDate       DateTime         @default(now()) @map("start_date")
  endDate         DateTime?        @map("end_date")
  status          InvestmentStatus @default(ACTIVE)
  lastPayoutAt    DateTime?        @map("last_payout_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  deletedAt       DateTime?        @map("deleted_at")

  // Relations
  user            User            @relation(fields: [userId], references: [id])
  order           Order           @relation(fields: [orderId], references: [id])
  plan            InvestmentPlan  @relation(fields: [planId], references: [id])
  payouts         InvestmentPayout[]

  @@map("investments")
}

model InvestmentPayout {
  id            String   @id @default(uuid())
  investmentId  String   @map("investment_id")
  amount        Decimal  @db.Decimal(20, 8)
  payoutDate    DateTime @default(now()) @map("payout_date")
  
  investment    Investment @relation(fields: [investmentId], references: [id])

  @@map("investment_payouts")
}

model MlmTree {
  userId    String @id @map("user_id")
  sponsorId String @map("sponsor_id")
  
  // Storing closure table or path could be better for complex queries, 
  // but for now strict adjacency list via User table is effectively mirrored here 
  // or this can be used as a materialized path view. 
  // For simplicity based on YAML, we might just rely on User.sponsorId.
  // BUT if we want a separate tree structure:
  
  user      User @relation("UserPosition", fields: [userId], references: [id])
  sponsor   User @relation("SponsorPosition", fields: [sponsorId], references: [id])

  @@map("mlm_tree")
}

model MlmCommission {
  id          String   @id @default(uuid())
  earnerId    String   @map("earner_id")
  buyerId     String   @map("buyer_id")
  orderId     String   @map("order_id")
  level       Int
  amount      Decimal  @db.Decimal(20, 8)
  createdAt   DateTime @default(now()) @map("created_at")

  earner      User     @relation("Earner", fields: [earnerId], references: [id])
  buyer       User     @relation("Buyer", fields: [buyerId], references: [id])
  order       Order    @relation(fields: [orderId], references: [id])

  @@map("mlm_commissions")
}

model Wallet {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  balance     Decimal  @default(0) @db.Decimal(20, 8)
  currency    String   @default("EUR")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id])
  ledger      WalletLedger[]

  // Constraint: Balance should ideally not be negative. 
  // Prisma doesn't support CHECK constraints natively in schema DSL yet (need raw SQL migration),
  // but we document it.

  @@map("wallets")
}

model WalletLedger {
  id          String   @id @default(uuid())
  walletId    String   @map("wallet_id")
  type        WalletTransactionType
  source      LedgerSource
  amount      Decimal  @db.Decimal(20, 8) // Positive for credit, negative for debit
  reference   String?  // e.g., InvestmentID, CommissionID
  balanceAfter Decimal @map("balance_after") @db.Decimal(20, 8)
  status      String   @default("COMPLETED") // PENDING, COMPLETED, FAILED
  createdAt   DateTime @default(now()) @map("created_at")

  wallet      Wallet   @relation(fields: [walletId], references: [id])

  @@map("wallet_ledger")
}

// -----------------------------------------------------------------------------
// Reliability & Infrastructure
// -----------------------------------------------------------------------------

model ProcessedWebhook {
  id          String   @id @default(uuid())
  provider    String   // 'STRIPE', 'MANGOPAY'
  eventId     String   @map("event_id")
  processedAt DateTime @default(now()) @map("processed_at")

  @@unique([provider, eventId])
  @@map("processed_webhooks")
}

model OutboxEvent {
  id            String   @id @default(uuid())
  aggregateType String   @map("aggregate_type") // 'ORDER', 'USER'
  aggregateId   String   @map("aggregate_id")
  type          String   // 'ORDER_PAID', 'USER_REGISTERED'
  payload       Json
  status        String   @default("PENDING") // PENDING, PUBLISHED, FAILED
  schemaVersion Int      @default(1) @map("schema_version")
  createdAt     DateTime @default(now()) @map("created_at")
  processedAt   DateTime? @map("processed_at")

  @@map("outbox_events")
}

model DepositRequest {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  amount        Decimal  @db.Decimal(20, 8)
  method        String   // 'CARD', 'BANK', 'MOBILE', 'QR'
  payerPhoneNumber String? @map("payer_phone_number")
  currency      String   @default("EUR")
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  referenceCode String   @unique @map("reference_code")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user          User     @relation(fields: [userId], references: [id])

  @@map("deposit_requests")
}

model SystemSetting {
  key         String   @id
  value       String   // JSON string or simple value
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// -----------------------------------------------------------------------------
// Support Chat
// -----------------------------------------------------------------------------

enum SupportStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportCategory {
  BILLING
  TECHNICAL
  GENERAL
}

enum SupportPriority {
  LOW
  MEDIUM
  HIGH
}

model SupportConversation {
  id           String             @id @default(uuid())
  userId       String             @map("user_id")
  status       SupportStatus      @default(OPEN)
  subject      String
  category     SupportCategory
  priority     SupportPriority    @default(MEDIUM)
  assignedToId String?            @map("assigned_to_id")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  user         User               @relation(fields: [userId], references: [id])
  assignedTo   User?              @relation("AssignedSupport", fields: [assignedToId], references: [id])
  messages     SupportMessage[]

  @@map("support_conversations")
}

model SupportMessage {
  id             String              @id @default(uuid())
  conversationId String              @map("conversation_id")
  senderId       String              @map("sender_id")
  content        String
  attachmentUrl  String?             @map("attachment_url")
  attachmentType String?             @map("attachment_type") // 'IMAGE', 'DOCUMENT', etc.
  read           Boolean             @default(false)
  createdAt      DateTime            @default(now()) @map("created_at")

  conversation   SupportConversation @relation(fields: [conversationId], references: [id])
  sender         User                @relation(fields: [senderId], references: [id])

  @@map("support_messages")
}
